---
openapi: 3.0.1
info:
  title: Beam Deflection API
  version: v1
  description: |
    JSON API for managing beams, beam deflection calculations, and moderation workflows.

    **Authentication**: JWT tokens (Bearer format) issued by /api/auth/sign_in or /api/auth/sign_up

    **Security**: Tokens are blacklisted on sign out using Redis. Blacklisted tokens return 401 Unauthorized.
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
security:
- bearerAuth: []
paths:
  "/api/auth/sign_in":
    post:
      summary: Sign in and receive JWT
      tags:
      - Auth
      parameters: []
      responses:
        '200':
          description: Signed in
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                  user:
                    type: object
                    properties:
                      id:
                        type: integer
                      email:
                        type: string
                      moderator:
                        type: boolean
        '401':
          description: Invalid credentials
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required:
              - email
              - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  example: secret123
  "/api/auth/sign_up":
    post:
      summary: Register and receive JWT
      tags:
      - Auth
      parameters: []
      responses:
        '201':
          description: User created
        '422':
          description: Validation error
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required:
              - email
              - password
              - password_confirmation
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  minLength: 6
                password_confirmation:
                  type: string
  "/api/auth/sign_out":
    post:
      summary: Sign out and blacklist JWT token
      description: |
        Signs out the current user by adding their JWT token to the Redis blacklist.
        The token will be rejected on all future requests until it naturally expires.
      tags:
      - Auth
      security:
      - bearerAuth: []
      responses:
        '200':
          description: Successfully signed out and token blacklisted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Successfully signed out
        '401':
          description: Unauthorized (no valid token provided)
  "/api/me":
    get:
      summary: Current user profile
      tags:
      - Me
      security:
      - bearerAuth: []
      responses:
        '200':
          description: Profile returned
    put:
      summary: Update current user credentials
      tags:
      - Me
      security:
      - bearerAuth: []
      parameters: []
      responses:
        '200':
          description: Updated
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  minLength: 6
                password_confirmation:
                  type: string
  "/api/beam_deflection_beams":
    post:
      summary: Add beam to current draft beam deflection
      tags:
      - BeamDeflections
      security:
      - bearerAuth: []
      parameters: []
      responses:
        '201':
          description: Beam added to cart
        '401':
          description: Unauthorized
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required:
              - beam_id
              - quantity
              properties:
                beam_id:
                  type: integer
                quantity:
                  type: integer
                  minimum: 1
  "/api/beam_deflections":
    get:
      summary: List beam deflections (заявки)
      description: |
        Returns list of beam deflections (заявки).
        - **Regular users**: see only their own non-draft beam deflections
        - **Moderators**: see ALL non-deleted beam deflections (including drafts)
        - Deleted beam deflections are always excluded
        - Supports filtering by status and date range
      tags:
      - BeamDeflections
      security:
      - bearerAuth: []
      parameters:
      - name: status
        in: query
        description: Filter by status (draft, formed, completed, rejected). Note - draft only visible to moderators.
        schema:
          type: string
          enum: [draft, formed, completed, rejected]
      - name: from
        in: query
        description: Filter formed_at from date (YYYY-MM-DD)
        schema:
          type: string
          format: date
      - name: to
        in: query
        description: Filter formed_at to date (YYYY-MM-DD)
        schema:
          type: string
          format: date
      - name: page
        in: query
        description: Page number (default 1)
        schema:
          type: integer
          minimum: 1
      - name: per_page
        in: query
        description: Items per page (default 20, max 100)
        schema:
          type: integer
          minimum: 1
          maximum: 100
      responses:
        '200':
          description: List of beam deflections
          content:
            application/json:
              schema:
                type: object
                properties:
                  beam_deflections:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                        status:
                          type: string
                        formed_at:
                          type: string
                          format: date-time
                        completed_at:
                          type: string
                          format: date-time
                        length_m:
                          type: number
                        udl_kn_m:
                          type: number
                        note:
                          type: string
                        creator_login:
                          type: string
                        moderator_login:
                          type: string
                        result_deflection_mm:
                          type: number
                  meta:
                    type: object
                    properties:
                      current_page:
                        type: integer
                      next_page:
                        type: integer
                      prev_page:
                        type: integer
                      total_pages:
                        type: integer
                      total_count:
                        type: integer
        '401':
          description: Unauthorized
  "/api/beam_deflections/{id}":
    get:
      summary: Get beam deflection by ID
      tags:
      - BeamDeflections
      security:
      - bearerAuth: []
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      responses:
        '200':
          description: Beam deflection details
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  status:
                    type: string
                  length_m:
                    type: number
                  udl_kn_m:
                    type: number
                  note:
                    type: string
                  formed_at:
                    type: string
                    format: date-time
                  completed_at:
                    type: string
                    format: date-time
                  creator_login:
                    type: string
                  moderator_login:
                    type: string
                  result_deflection_mm:
                    type: number
                  within_norm:
                    type: boolean
                  items:
                    type: array
                    items:
                      type: object
                      properties:
                        beam_id:
                          type: integer
                        beam_name:
                          type: string
                        beam_material:
                          type: string
                        quantity:
                          type: integer
                        deflection_mm:
                          type: number
        '401':
          description: Unauthorized
        '403':
          description: Not authorized to view this beam deflection
        '404':
          description: Beam deflection not found
    put:
      summary: Update beam deflection (draft or formed only)
      tags:
      - BeamDeflections
      security:
      - bearerAuth: []
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                beam_deflection:
                  type: object
                  properties:
                    length_m:
                      type: number
                      minimum: 0.01
                    udl_kn_m:
                      type: number
                      minimum: 0.01
                    note:
                      type: string
      responses:
        '200':
          description: Beam deflection updated
        '401':
          description: Unauthorized
        '403':
          description: Not authorized (must be creator)
        '422':
          description: Validation error
    delete:
      summary: Delete (soft delete) beam deflection
      tags:
      - BeamDeflections
      security:
      - bearerAuth: []
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      responses:
        '204':
          description: Beam deflection deleted
        '401':
          description: Unauthorized
        '403':
          description: Not authorized (must be creator)
  "/api/beam_deflections/{id}/form":
    put:
      summary: Validate draft and mark as formed (user only)
      tags:
      - BeamDeflections
      security:
      - bearerAuth: []
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      responses:
        '200':
          description: BeamDeflection formed
        '403':
          description: Cannot form foreign beam deflection
        '422':
          description: Required fields missing or empty cart
  "/api/beam_deflections/{id}/complete":
    put:
      summary: Complete formed beam deflection (moderator only)
      description: |
        Calculates deflection results and marks beam deflection as completed.
        Only moderators can perform this action.
        Beam deflection must be in 'formed' status.
      tags:
      - BeamDeflections
      security:
      - bearerAuth: []
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      responses:
        '200':
          description: BeamDeflection completed with calculation results
        '401':
          description: Unauthorized
        '403':
          description: Requires moderator role
        '422':
          description: Beam deflection must be in formed status
  "/api/beam_deflections/{id}/reject":
    put:
      summary: Reject formed beam deflection (moderator only)
      description: |
        Rejects a beam deflection that is in 'formed' status.
        Only moderators can perform this action.
      tags:
      - BeamDeflections
      security:
      - bearerAuth: []
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      responses:
        '200':
          description: BeamDeflection rejected
        '401':
          description: Unauthorized
        '403':
          description: Requires moderator role
        '422':
          description: Beam deflection must be in formed status
  "/api/beams":
    get:
      summary: List beams (public)
      tags:
      - Beams
      responses:
        '200':
          description: Beams returned
    post:
      summary: Create beam (moderator only)
      tags:
      - Beams
      security:
      - bearerAuth: []
      parameters: []
      responses:
        '201':
          description: Beam created
        '403':
          description: Forbidden for non-moderators
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required:
              - name
              - material
              - elasticity_gpa
              - inertia_cm4
              - allowed_deflection_ratio
              properties:
                name:
                  type: string
                material:
                  type: string
                  enum:
                  - wooden
                  - steel
                  - reinforced_concrete
                elasticity_gpa:
                  type: number
                inertia_cm4:
                  type: number
                allowed_deflection_ratio:
                  type: integer
  "/api/beams/{id}":
    get:
      summary: Fetch beam details (public)
      tags:
      - Beams
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      responses:
        '200':
          description: Beam found
    put:
      summary: Update beam (moderator only)
      tags:
      - Beams
      security:
      - bearerAuth: []
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      responses:
        '200':
          description: Beam updated
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                material:
                  type: string
                allowed_deflection_ratio:
                  type: integer
    delete:
      summary: Delete beam (moderator only)
      tags:
      - Beams
      security:
      - bearerAuth: []
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      responses:
        '204':
          description: Beam deleted
servers:
- url: "{scheme}://{host}"
  variables:
    scheme:
      default: http
    host:
      default: localhost:3000
