---
openapi: 3.0.1
info:
  title: Beam Deflection API
  version: v1
  description: |
    JSON API for managing beams, beam deflection calculations, and moderation workflows.

    **Authentication**: JWT tokens (Bearer format) issued by /api/auth/sign_in or /api/auth/sign_up

    **Security**: Tokens are blacklisted on sign out using Redis. Blacklisted tokens return 401 Unauthorized.
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
paths:
  "/api/auth/sign_in":
    post:
      operationId: authSignIn
      summary: Sign in and receive JWT
      tags:
      - Auth
      parameters: []
      responses:
        '200':
          description: Signed in
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                  user:
                    type: object
                    properties:
                      id:
                        type: integer
                      email:
                        type: string
                      moderator:
                        type: boolean
        '401':
          description: Invalid credentials
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required:
              - email
              - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  example: secret123
  "/api/auth/sign_up":
    post:
      operationId: authSignUp
      summary: Register and receive JWT
      tags:
      - Auth
      parameters: []
      responses:
        '201':
          description: User created
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                  user:
                    type: object
                    properties:
                      id:
                        type: integer
                      email:
                        type: string
                      moderator:
                        type: boolean
        '422':
          description: Validation error
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required:
              - email
              - password
              - password_confirmation
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  minLength: 6
                password_confirmation:
                  type: string
  "/api/auth/sign_out":
    post:
      operationId: authSignOut
      summary: Sign out and blacklist JWT token
      description: |
        Signs out the current user by adding their JWT token to the Redis blacklist.
        The token will be rejected on all future requests until it naturally expires.
      tags:
      - Auth
      security:
      - bearerAuth: []
      responses:
        '200':
          description: Successfully signed out and token blacklisted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Successfully signed out
        '401':
          description: Unauthorized (no valid token provided)
  "/api/me":
    get:
      operationId: meShow
      summary: Current user profile
      tags:
      - Me
      security:
      - bearerAuth: []
      responses:
        '200':
          description: Profile returned
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  email:
                    type: string
                  moderator:
                    type: boolean
    put:
      operationId: meUpdate
      summary: Update current user credentials
      tags:
      - Me
      security:
      - bearerAuth: []
      parameters: []
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  email:
                    type: string
                  moderator:
                    type: boolean
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  minLength: 6
                password_confirmation:
                  type: string
  "/api/beam_deflections/cart_badge":
    get:
      operationId: beamDeflectionsCartBadge
      summary: Get current draft id and items count
      tags:
      - BeamDeflections
      security:
      - bearerAuth: []
      responses:
        '200':
          description: Draft id and total items count
          content:
            application/json:
              schema:
                type: object
                properties:
                  beam_deflection_id:
                    type: integer
                  items_count:
                    type: integer
        '401':
          description: Unauthorized
  "/api/beam_deflections":
    get:
      operationId: beamDeflectionsList
      summary: List beam deflections (заявки)
      description: |
        Returns list of beam deflections (заявки).
        - **Regular users**: see only their own non-draft beam deflections
        - **Moderators**: see ALL non-deleted beam deflections (including drafts)
        - Deleted beam deflections are always excluded
        - Supports filtering by status and date range
      tags:
      - BeamDeflections
      security:
      - bearerAuth: []
      parameters:
      - name: status
        in: query
        description: Filter by status (draft, formed, completed, rejected). Note - draft only visible to moderators.
        schema:
          type: string
          enum: [draft, formed, completed, rejected]
      - name: from
        in: query
        description: Filter formed_at from date (YYYY-MM-DD)
        schema:
          type: string
          format: date
      - name: to
        in: query
        description: Filter formed_at to date (YYYY-MM-DD)
        schema:
          type: string
          format: date
      - name: page
        in: query
        description: Page number (default 1)
        schema:
          type: integer
          minimum: 1
      - name: per_page
        in: query
        description: Items per page (default 20, max 100)
        schema:
          type: integer
          minimum: 1
          maximum: 100
      responses:
        '200':
          description: List of beam deflections
          content:
            application/json:
              schema:
                type: object
                properties:
                  beam_deflections:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                        status:
                          type: string
                        formed_at:
                          type: string
                          format: date-time
                        completed_at:
                          type: string
                          format: date-time
                        note:
                          type: string
                        creator_login:
                          type: string
                        moderator_login:
                          type: string
                        result_deflection_mm:
                          type: number
                  meta:
                    type: object
                    properties:
                      current_page:
                        type: integer
                      next_page:
                        type: integer
                      prev_page:
                        type: integer
                      total_pages:
                        type: integer
                      total_count:
                        type: integer
        '401':
          description: Unauthorized
  "/api/beam_deflections/{id}":
    get:
      operationId: beamDeflectionsShow
      summary: Get beam deflection by ID
      tags:
      - BeamDeflections
      security:
      - bearerAuth: []
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      responses:
        '200':
          description: Beam deflection details
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  status:
                    type: string
                  note:
                    type: string
                  formed_at:
                    type: string
                    format: date-time
                  completed_at:
                    type: string
                    format: date-time
                  creator_login:
                    type: string
                  moderator_login:
                    type: string
                  result_deflection_mm:
                    type: number
                  within_norm:
                    type: boolean
                  items:
                    type: array
                    items:
                      type: object
                      properties:
                        beam_id:
                          type: integer
                        beam_name:
                          type: string
                        beam_material:
                          type: string
                        beam_image_url:
                          type: string
                          nullable: true
                        quantity:
                          type: integer
                        length_m:
                          type: number
                          nullable: true
                        udl_kn_m:
                          type: number
                          nullable: true
                        position:
                          type: integer
                        deflection_mm:
                          type: number
        '401':
          description: Unauthorized
        '403':
          description: Not authorized to view this beam deflection
        '404':
          description: Beam deflection not found
    put:
      operationId: beamDeflectionsUpdate
      summary: Update beam deflection (draft or formed only)
      tags:
      - BeamDeflections
      security:
      - bearerAuth: []
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                beam_deflection:
                  type: object
                  properties:
                    note:
                      type: string
      responses:
        '200':
          description: Beam deflection updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  status:
                    type: string
                  note:
                    type: string
                  formed_at:
                    type: string
                    format: date-time
                  completed_at:
                    type: string
                    format: date-time
                  creator_login:
                    type: string
                  moderator_login:
                    type: string
                  result_deflection_mm:
                    type: number
                  within_norm:
                    type: boolean
                  items:
                    type: array
                    items:
                      type: object
                      properties:
                        beam_id:
                          type: integer
                        beam_name:
                          type: string
                        beam_material:
                          type: string
                        beam_image_url:
                          type: string
                          nullable: true
                        quantity:
                          type: integer
                        length_m:
                          type: number
                          nullable: true
                        udl_kn_m:
                          type: number
                          nullable: true
                        position:
                          type: integer
                        deflection_mm:
                          type: number
        '401':
          description: Unauthorized
        '403':
          description: Not authorized (must be creator)
        '422':
          description: Validation error
    delete:
      operationId: beamDeflectionsDelete
      summary: Delete (soft delete) beam deflection
      tags:
      - BeamDeflections
      security:
      - bearerAuth: []
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      responses:
        '204':
          description: Beam deflection deleted
        '401':
          description: Unauthorized
        '403':
          description: Not authorized (must be creator)
  "/api/beam_deflections/{beam_deflection_id}/items/update_item":
    put:
      operationId: beamDeflectionsUpdateItem
      summary: Update item inside draft beam deflection
      tags:
      - BeamDeflections
      security:
      - bearerAuth: []
      parameters:
      - name: beam_deflection_id
        in: path
        required: true
        schema:
          type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required:
              - beam_id
              - beam_deflection_beam
              properties:
                beam_id:
                  type: integer
                beam_deflection_beam:
                  type: object
                  properties:
                    quantity:
                      type: integer
                      minimum: 1
                    length_m:
                      type: number
                      minimum: 0.001
                      nullable: true
                    udl_kn_m:
                      type: number
                      minimum: 0
                      nullable: true
                    position:
                      type: integer
                      minimum: 1
      responses:
        '200':
          description: Item updated
        '401':
          description: Unauthorized
        '403':
          description: Not authorized (must be creator and draft)
        '422':
          description: Validation error
  "/api/beam_deflections/{beam_deflection_id}/items/remove_item":
    delete:
      operationId: beamDeflectionsRemoveItem
      summary: Remove item from draft beam deflection
      tags:
      - BeamDeflections
      security:
      - bearerAuth: []
      parameters:
      - name: beam_deflection_id
        in: path
        required: true
        schema:
          type: integer
      - name: beam_id
        in: query
        required: true
        schema:
          type: integer
      responses:
        '204':
          description: Item removed
        '401':
          description: Unauthorized
        '403':
          description: Not authorized (must be creator and draft)
        '404':
          description: Item not found
  "/api/beam_deflections/{id}/form":
    put:
      operationId: beamDeflectionsForm
      summary: Validate draft and mark as formed (user only)
      tags:
      - BeamDeflections
      security:
      - bearerAuth: []
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      responses:
        '200':
          description: BeamDeflection formed
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  status:
                    type: string
                  note:
                    type: string
                  formed_at:
                    type: string
                    format: date-time
                  completed_at:
                    type: string
                    format: date-time
                  creator_login:
                    type: string
                  moderator_login:
                    type: string
                  result_deflection_mm:
                    type: number
                  within_norm:
                    type: boolean
                  items:
                    type: array
                    items:
                      type: object
                      properties:
                        beam_id:
                          type: integer
                        beam_name:
                          type: string
                        beam_material:
                          type: string
                        beam_image_url:
                          type: string
                          nullable: true
                        quantity:
                          type: integer
                        length_m:
                          type: number
                          nullable: true
                        udl_kn_m:
                          type: number
                          nullable: true
                        position:
                          type: integer
                        deflection_mm:
                          type: number
        '403':
          description: Cannot form foreign beam deflection
        '422':
          description: Required fields missing or empty cart
  "/api/beam_deflections/{id}/complete":
    put:
      operationId: beamDeflectionsComplete
      summary: Complete formed beam deflection (moderator only)
      description: |
        Calculates deflection results and marks beam deflection as completed.
        Only moderators can perform this action.
        Beam deflection must be in 'formed' status.
      tags:
      - BeamDeflections
      security:
      - bearerAuth: []
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      responses:
        '200':
          description: BeamDeflection completed with calculation results
        '401':
          description: Unauthorized
        '403':
          description: Requires moderator role
        '422':
          description: Beam deflection must be in formed status
  "/api/beam_deflections/{id}/reject":
    put:
      operationId: beamDeflectionsReject
      summary: Reject formed beam deflection (moderator only)
      description: |
        Rejects a beam deflection that is in 'formed' status.
        Only moderators can perform this action.
      tags:
      - BeamDeflections
      security:
      - bearerAuth: []
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      responses:
        '200':
          description: BeamDeflection rejected
        '401':
          description: Unauthorized
        '403':
          description: Requires moderator role
        '422':
          description: Beam deflection must be in formed status
  "/api/beams":
    get:
      operationId: beamsList
      summary: List beams (public)
      tags:
      - Beams
      parameters:
      - name: q
        in: query
        description: Search query (by name)
        schema:
          type: string
      - name: active
        in: query
        description: Include inactive beams (pass active=false)
        schema:
          type: boolean
      - name: page
        in: query
        description: Page number (default 1)
        schema:
          type: integer
          minimum: 1
      - name: per_page
        in: query
        description: Items per page (default 20, max 100)
        schema:
          type: integer
          minimum: 1
          maximum: 100
      responses:
        '200':
          description: Beams returned
          content:
            application/json:
              schema:
                type: object
                properties:
                  beams:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                        name:
                          type: string
                        description:
                          type: string
                          nullable: true
                        active:
                          type: boolean
                        image_url:
                          type: string
                          nullable: true
                        image_key:
                          type: string
                          nullable: true
                        material:
                          type: string
                        elasticity_gpa:
                          type: number
                        inertia_cm4:
                          type: number
                        allowed_deflection_ratio:
                          type: integer
                  meta:
                    type: object
                    properties:
                      current_page:
                        type: integer
                      next_page:
                        type: integer
                      prev_page:
                        type: integer
                      total_pages:
                        type: integer
                      total_count:
                        type: integer
    post:
      operationId: beamsCreate
      summary: Create beam (moderator only)
      tags:
      - Beams
      security:
      - bearerAuth: []
      parameters: []
      responses:
        '201':
          description: Beam created
        '403':
          description: Forbidden for non-moderators
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required:
              - name
              - material
              - elasticity_gpa
              - inertia_cm4
              - allowed_deflection_ratio
              properties:
                name:
                  type: string
                material:
                  type: string
                  enum:
                  - wooden
                  - steel
                  - reinforced_concrete
                elasticity_gpa:
                  type: number
                inertia_cm4:
                  type: number
                allowed_deflection_ratio:
                  type: integer
  "/api/beams/{id}":
    get:
      operationId: beamsShow
      summary: Fetch beam details (public)
      tags:
      - Beams
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      responses:
        '200':
          description: Beam found
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  name:
                    type: string
                  description:
                    type: string
                    nullable: true
                  active:
                    type: boolean
                  image_url:
                    type: string
                    nullable: true
                  image_key:
                    type: string
                    nullable: true
                  material:
                    type: string
                  elasticity_gpa:
                    type: number
                  inertia_cm4:
                    type: number
                  allowed_deflection_ratio:
                    type: integer
    put:
      operationId: beamsUpdate
      summary: Update beam (moderator only)
      tags:
      - Beams
      security:
      - bearerAuth: []
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      responses:
        '200':
          description: Beam updated
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                material:
                  type: string
                allowed_deflection_ratio:
                  type: integer
    delete:
      operationId: beamsDelete
      summary: Delete beam (moderator only)
      tags:
      - Beams
      security:
      - bearerAuth: []
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      responses:
        '204':
          description: Beam deleted
  "/api/beams/{id}/add_to_draft":
    post:
      operationId: beamsAddToDraft
      summary: Add beam to current draft beam deflection
      tags:
      - Beams
      security:
      - bearerAuth: []
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      - name: quantity
        in: query
        required: false
        schema:
          type: integer
          minimum: 1
      responses:
        '200':
          description: Beam added to draft
          content:
            application/json:
              schema:
                type: object
                properties:
                  beam_deflection_id:
                    type: integer
                  items_count:
                    type: integer
        '401':
          description: Unauthorized
servers:
- url: /
