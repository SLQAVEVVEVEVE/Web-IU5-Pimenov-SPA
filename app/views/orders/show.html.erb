<%# app/views/orders/show.html.erb %>
<h1 class="page-title">Текущая заявка</h1>

<div class="toolbar" style="justify-content:space-between; gap:12px;">
  <div>
    <%= link_to "К выбору", beams_path, class: "btn btn--secondary" %>
  </div>
  
  <div style="display: flex; gap: 12px;">
    <% if @beam_deflection.draft? || @beam_deflection.formed? %>
      <%= button_to "Завершить", complete_order_path(@beam_deflection),
            method: :post,
            class: "btn btn--primary",
            form: { data: { turbo_confirm: "Завершить заявку и выполнить расчёт?" } } %>
    <% end %>
    
    <%# Кнопка логического удаления заявки (НЕ ORM) — оставляем как в проекте %>
    <%= form_with url: delete_order_path(@beam_deflection), method: :post, local: true do |f| %>
      <%= f.submit "Удалить заявку", class: "btn btn--danger" %>
    <% end %>
  </div>
</div>

<%# Display calculation results if available %>
<% if @beam_deflection.result_deflection_mm.present? %>
  <div class="card" style="margin-bottom: 24px; padding: 16px;">
    <h3 style="margin-top: 0; margin-bottom: 12px;">Результаты расчёта</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
      <div>
        <div style="font-size: 14px; color: #6b7280; margin-bottom: 4px;">Суммарный прогиб</div>
        <div style="font-size: 20px; font-weight: 600;">
          <%= number_with_precision(@beam_deflection.result_deflection_mm, precision: 2) %> <span style="font-size: 14px; color: #6b7280;">мм</span>
        </div>
      </div>
      <% if @beam_deflection.calculated_at %>
        <div>
          <div style="font-size: 14px; color: #6b7280; margin-bottom: 4px;">Рассчитано</div>
          <div style="font-size: 14px;">
            <%= l(@beam_deflection.calculated_at, format: :long) %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<% if @items.any? %>
  <div class="grid">
    <% @items.each do |item| %>
      <% b = item.beam %>

      <div class="card card--grid">
        <div class="card__thumb-wrap">
          <%= image_tag minio_image_url(b.image_url), alt: b.name, class: "card__thumb" %>
        </div>

        <div class="card__body">
          <h3 class="card__title"><%= b.name %></h3>

          <div class="card__meta">
            Материал: <%= b.material %> · Модуль E: <%= b.elasticity_gpa %> ГПа · Норма: L/<%= b.allowed_deflection_ratio %>
          </div>

          <div class="order-inputs">
            <label class="order-inputs__field">
              <span>Длина, м</span>
              <input type="number" step="0.1" value="<%= item.length_m || 3.0 %>" name="length_<%= item.id %>" form="update_form_#{item.id}" />
            </label>

            <label class="order-inputs__field">
              <span>Нагрузка q, кН/м</span>
              <input type="number" step="0.1" value="<%= item.udl_kn_m || 10.0 %>" name="udl_kn_m_<%= item.id %>" form="update_form_#{item.id}" />
            </label>

            <div class="order-qty">× <%= item.quantity %></div>
          </div>
          
          <% if item.deflection_mm.present? %>
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #eee;">
              <div style="font-size: 14px; color: #6b7280;">Прогиб по позиции:</div>
              <div style="font-weight: 500;">
                <%= number_with_precision(item.deflection_mm, precision: 2) %> <span style="font-size: 14px; color: #6b7280;">мм</span>
              </div>
            </div>
          <% end %>
          
          <% if @beam_deflection.draft? || @beam_deflection.formed? %>
            <%= form_with url: update_order_item_path(item), method: :patch, local: true, id: "update_form_#{item.id}" do |f| %>
              <%= f.hidden_field :id, value: item.id %>
              <button type="submit" class="btn btn--small" style="margin-top: 8px;">Обновить</button>
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
<% else %>
  <p style="text-align:center;color:#6b7280;margin-top:16px">
    В заявке пока нет услуг.
  </p>
<% end %>
